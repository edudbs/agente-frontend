<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Agente de Agenda Inteligente</title>
ย ย <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
ย ย <style>
ย ย ย ย /* --- ESTILOS PARA TEMA ESCURO --- */
ย ย ย ย body { 
ย ย ย ย ย ย font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
ย ย ย ย ย ย margin: 20px; 
ย ย ย ย ย ย background-color: #1a1a2e; /* Fundo muito escuro */
ย ย ย ย ย ย color: #e0e0e0; /* Texto claro padrรฃo */
ย ย ย ย }
ย ย ย ย .container { 
ย ย ย ย ย ย max-width: 700px; 
ย ย ย ย ย ย margin: 0 auto; 
ย ย ย ย ย ย background: #2a2a4a; /* Fundo do container ligeiramente mais claro */
ย ย ย ย ย ย padding: 25px; 
ย ย ย ย ย ย border-radius: 12px; 
ย ย ย ย ย ย box-shadow: 0 6px 15px rgba(0,0,0,0.3);
ย ย ย ย }
ย ย ย ย h1 { 
ย ย ย ย ย ย color: #92e6a7; /* Verde claro para o tรญtulo */
ย ย ย ย ย ย text-align: center; 
ย ย ย ย ย ย margin-bottom: 20px; 
ย ย ย ย }
ย ย ย ย #chat-area { 
ย ย ย ย ย ย border: 1px solid #4a4a6e;
ย ย ย ย ย ย padding: 15px; 
ย ย ย ย ย ย height: 350px; 
ย ย ย ย ย ย overflow-y: auto; 
ย ย ย ย ย ย margin-bottom: 15px; 
ย ย ย ย ย ย background-color: #24243e; /* Fundo da รกrea de chat */
ย ย ย ย ย ย border-radius: 8px; 
ย ย ย ย ย ย line-height: 1.6; 
ย ย ย ย }
ย ย ย ย .user-message { 
ย ย ย ย ย ย text-align: right; 
ย ย ย ย ย ย margin: 10px 0; 
ย ย ย ย ย ย padding: 8px 12px; 
ย ย ย ย ย ย background-color: #005f99; /* Azul escuro para mensagens do usuรกrio */
ย ย ย ย ย ย color: #ffffff; 
ย ย ย ย ย ย border-radius: 15px 15px 0 15px; 
ย ย ย ย ย ย max-width: 80%; 
ย ย ย ย ย ย margin-left: auto; 
ย ย ย ย }
ย ย ย ย .agent-message { 
ย ย ย ย ย ย text-align: left; 
ย ย ย ย ย ย margin: 10px 0; 
ย ย ย ย ย ย padding: 10px 15px; 
ย ย ย ย ย ย background-color: #4a4a6e; /* Fundo escuro do agente */
ย ย ย ย ย ย color: #e0e0e0; 
ย ย ย ย ย ย border-radius: 15px 15px 15px 0; 
ย ย ย ย ย ย max-width: 80%; 
ย ย ย ย }
ย ย ย ย .agent-message ul, .agent-message ol { 
ย ย ย ย ย ย padding-left: 20px; 
ย ย ย ย ย ย margin: 5px 0; 
ย ย ย ย ย ย color: #c0c0c0;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย #command-input { 
ย ย ย ย ย ย width: calc(100% - 100px); 
ย ย ย ย ย ย padding: 12px; 
ย ย ย ย ย ย box-sizing: border-box; 
ย ย ย ย ย ย border: 1px solid #92e6a7; 
ย ย ย ย ย ย border-radius: 20px 0 0 20px; 
ย ย ย ย ย ย outline: none; 
ย ย ย ย ย ย display: inline-block; 
ย ย ย ย ย ย background-color: #3a3a5a; /* Fundo do input */
ย ย ย ย ย ย color: #e0e0e0; /* Texto digitado */
ย ย ย ย }
ย ย ย ย #command-input::placeholder {
ย ย ย ย ย ย color: #a0a0b0; /* Cor do placeholder */
ย ย ย ย }
ย ย ย ย button { 
ย ย ย ย ย ย width: 100px; 
ย ย ย ย ย ย padding: 12px; 
ย ย ย ย ย ย background-color: #92e6a7; /* Verde claro para o botรฃo */
ย ย ย ย ย ย color: #1a1a2e; /* Texto escuro no botรฃo */
ย ย ย ย ย ย border: none; 
ย ย ย ย ย ย cursor: pointer; 
ย ย ย ย ย ย border-radius: 0 20px 20px 0; 
ย ย ย ย ย ย display: inline-block; 
ย ย ย ย ย ย margin-left: -5px; 
ย ย ย ย }
ย ย ย ย button:hover { 
ย ย ย ย ย ย background-color: #7bd48f; 
ย ย ย ย }
ย ย ย ย .input-group { 
ย ย ย ย ย ย display: flex; 
ย ย ย ย }
ย ย ย ย .error { 
ย ย ย ย ย ย color: #ff6b6b; 
ย ย ย ย ย ย font-weight: bold; 
ย ย ย ย }
ย ย ย ย small { 
ย ย ย ย ย ย display: block; 
ย ย ย ย ย ย margin-top: 5px; 
ย ย ย ย ย ย color: #a0a0b0; 
ย ย ย ย ย ย font-size: 0.8em; 
ย ย ย ย }
ย ย </style>
</head>
<body>
ย ย <div class="container">
ย ย ย ย <h1>๐๏ธ Seu Agente de Agenda</h1>
ย ย ย ย 
ย ย ย ย <div id="chat-area">
ย ย ย ย ย ย <div class="agent-message"><p><strong>Agente:</strong> Olรก! Seu agente de planejamento estรก online. Pergunte sobre sua agenda ou me peรงa para agendar algo!</p></div>
ย ย ย ย </div>
ย ย ย ย 
ย ย ย ย <div class="input-group">
ย ย ย ย ย ย <input type="text" id="command-input" placeholder="Ex: Sugira minha programaรงรฃo de amanhรฃ" required>
ย ย ย ย ย ย <button onclick="sendCommand()">Enviar</button>
ย ย ย ย </div>
ย ย ย ย 
ย ย ย ย <p style="margin-top: 15px; font-size: 0.7em; text-align: center;">URL: <span id="api-url-display"></span></p>
ย ย </div>

ย ย <script>
ย ย ย ย // --- CONFIGURAรรO ---
ย ย ย ย const API_BASE_URL = "https://agente-planejamento.onrender.com"; // EX: "https://seu-projeto.onrender.com"
ย ย ย ย const API_TOKEN = "tk_pergunta"; // EX: "seutokensecreto123"
ย ย ย ย 
ย ย ย ย const chatArea = document.getElementById('chat-area');
ย ย ย ย const input = document.getElementById('command-input');
ย ย ย ย 
ย ย ย ย document.getElementById('api-url-display').textContent = API_BASE_URL + "/chat";

ย ย ย ย // 1. Variรกvel GLOBAL para armazenar o histรณrico
ย ย ย ย // Estrutura: [{role: "user"|"model", text: "..."}]
ย ย ย ย let conversationHistory = [
ย ย ย ย ย ย // Prรฉ-popula o histรณrico com a mensagem inicial do agente
ย ย ย ย ย ย { role: 'model', text: 'Olรก! Seu agente de planejamento estรก online. Pergunte sobre sua agenda ou me peรงa para agendar algo!'}
ย ย ย ย ];


ย ย ย ย function appendMessage(sender, text, addToHistory = true) {
ย ย ย ย ย ย const messageDiv = document.createElement('div');
ย ย ย ย ย ย messageDiv.className = sender === 'user' ? 'user-message' : 'agent-message';
ย ย ย ย ย ย 
ย ย ย ย ย ย const messageText = document.createElement('p');
ย ย ย ย ย ย 
ย ย ย ย ย ย if (sender === 'agent') {
ย ย ย ย ย ย ย ย // Usa marked.js para converter o markdown em HTML
ย ย ย ย ย ย ย ย // Remove a tag <small> de diagnรณstico antes de renderizar (apenas se addToHistory for true, i.e., para a resposta principal)
ย ย ย ย ย ย ย ย const cleanText = text.replace(/<small>.*<\/small>/gs, '').trim(); 
ย ย ย ย ย ย ย ย messageText.innerHTML = `<strong>Agente:</strong> ${marked.parse(text)}`;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย if (addToHistory) {
ย ย ย ย ย ย ย ย ย ย // Adiciona APENAS o texto puro do agente (sem tags HTML) ao histรณrico
ย ย ย ย ย ย ย ย ย ย conversationHistory.push({ role: 'model', text: cleanText });
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } else { // 'user'
ย ย ย ย ย ย ย ย messageText.innerHTML = `<strong>Vocรช:</strong> ${text}`;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย if (addToHistory) {
ย ย ย ย ย ย ย ย ย ย // Adiciona o texto puro do usuรกrio ao histรณrico
ย ย ย ย ย ย ย ย ย ย conversationHistory.push({ role: 'user', text: text });
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }

ย ย ย ย ย ย messageDiv.appendChild(messageText);
ย ย ย ย ย ย chatArea.appendChild(messageDiv);
ย ย ย ย ย ย chatArea.scrollTop = chatArea.scrollHeight;
ย ย ย ย }
        
        // Remove a chamada inicial, pois ela estรก no array
        document.querySelector('.agent-message').remove();


ย ย ย ย async function sendCommand() {
ย ย ย ย ย ย const query = input.value.trim();
ย ย ย ย ย ย if (!query) return;

ย ย ย ย ย ย // 1. Adiciona a mensagem do usuรกrio ao histรณrico e exibe na tela
ย ย ย ย ย ย appendMessage('user', query);
ย ย ย ย ย ย input.value = '';

ย ย ย ย ย ย // 2. Monta a requisiรงรฃo, incluindo o histรณrico
ย ย ย ย ย ย const encodedQuery = encodeURIComponent(query);
ย ย ย ย ย ย 
            // Converte o array de histรณrico para JSON string e codifica
            const historyJson = encodeURIComponent(JSON.stringify(conversationHistory));
            
            // Monta a URL com os parรขmetros query e history
ย ย ย ย ย ย const url = `${API_BASE_URL}/chat?query=${encodedQuery}&token=${API_TOKEN}&history=${historyJson}`;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(url);
ย ย ย ย ย ย ย ย const data = await response.json();

ย ย ย ย ย ย ย ย if (response.ok) {
ย ย ย ย ย ย ย ย ย ย let agentResponse = data.answer;
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย // Adiciona info de diagnรณstico
ย ย ย ย ย ย ย ย ย ย let diagnosticInfo = '';
ย ย ย ย ย ย ย ย ย ย if (data.function_used) {
ย ย ย ย ย ย ย ย ย ย ย ย diagnosticInfo = `Funรงรฃo usada: ${data.function_used}`;
ย ย ย ย ย ย ย ย ย ย } else if (data.function_used === null) {
ย ย ย ย ย ย ย ย ย ย ย ย // Se a funรงรฃo for null, assumimos que foi uma resposta direta (ou confirmaรงรฃo)
ย ย ย ย ย ย ย ย ย ย ย ย diagnosticInfo = `Aรงรฃo realizada com sucesso (Resposta Direta).`; 
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย // 3. Adiciona a resposta do agente ao histรณrico E exibe na tela
ย ย ย ย ย ย ย ย ย ย // A funรงรฃo appendMessage agora cuida de adicionar ao histรณrico
ย ย ย ย ย ย ย ย ย ย appendMessage('agent', agentResponse + `\n\n<small>${diagnosticInfo}</small>`);

ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Nรฃo adicionamos erros ao histรณrico, pois sรฃo falhas tรฉcnicas
ย ย ย ย ย ย ย ย ย ย appendMessage('agent', `<span class="error">ERRO (${response.status}): ${data.detail || "Falha ao processar comando."}</span>`, false);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error("Erro de comunicaรงรฃo:", error);
ย ย ย ย ย ย ย ย appendMessage('agent', `<span class="error">ERRO DE COMUNICAรรO: Verifique a URL Base e o Token.</span>`, false);
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย input.addEventListener('keypress', function (e) {
ย ย ย ย ย ย if (e.key === 'Enter') {
ย ย ย ย ย ย ย ย sendCommand();
ย ย ย ย ย ย }
ย ย ย ย });
ย ย </script>
</body>
</html>
